# 실행 컨텍스트

## ✔️ 실행 컨텍스트란?

ECMAScript 스펙에서는 실행 가능한 코드를 형상화하고 구분하는 추상적인 개념이라고 정의한다. JavaScript 코드가 실행되기 위해 필요한 환경, 실행되는 환경을 제공하는 객체라고 할 수 있다.

실행 컨텍스트는 실행할 코드에 제공할 환경 정보(변수 정보)들을 모아 놓는다. 함수를 실행할 때마다 그 함수에 대한 새로운 실행 컨텍스트들이 생성되고 함수는 그 함수의 고유한 컨텍스트에서 실행된다.

소스 코드의 타입을 알아보고 넘어가자.

## ✔️ 소스 코드의 타입

| 소스 코드의 타입         | 설명                                                                                          |
| :----------------------- | :-------------------------------------------------------------------------------------------- |
| 전역 코드(global code)   | 전역에 존재하는 소스 코드. 전역에 정의된 함수, 클래스 등 내부 코드는 포함하지 않음.           |
| 함수 코드(function code) | 함수 내부에 존재하는 소스 코드. 함수 내부에 중첩된 함수, 클래스 등 내부 코드는 포함하지 않음. |
| eval 코드(eval code)     | 빌트인 전역 함수인 eval 함수에 인수로 전달되어 실행되는 소스 코드.                            |

위 세 가지 소스코드는 실행 컨텍스트를 생성한다.

### 1. 전역 코드

전역 코드는 최상위 스코프인 전역 스코프를 생성한다. 콜 스택에 전역 컨텍스트는 단 하나뿐이고 맨 처음 전역 컨텍스트부터 활성화된다.

### 2. 함수 코드

함수 코드는 해당 함수의 지역 스코프를 생성하고 지역 변수, 매개변수, arguments 객체를 관리한다.

### 3. eval 코드

eval 코드는 strict mode에서 자신만의 독자적인 스코프를 생성한다. 이를 위해 eval 코드가 평가되면 eval 실행 컨텍스트가 생성된다. 요즘에는 거의 쓰이지 않는다.

## ✔️ 실행 컨텍스트가 가지고 있는 정보

- 변수: 전역 변수(global), 지역 변수(local), 매개변수(parameter), 객체의 프로퍼티(property)
- 함수 선언
- 변수의 유효 범위(scope)
- this

## ✔️ 콜 스택

콜 스택은 실행 컨텍스트 정보가 담겨 있는 스택이라고 할 수 있다. LIFO(Last In, First Out) 구조로 가장 나중에 들어온 것이 가장 먼저 나가는 구조이므로 현재 실행 컨텍스트는 콜 스택의 맨 위에 있는 실행 컨텍스트라고 하면 이해가 쉬울 듯하다.

```javascript
var a = "apple";

function foo() {
  var b = "banana";

  function bar() {
    var c = "carrot";
    console.log(a + b + c);
  }
  bar();
}
foo();
```

위의 코드를 실행하면 아래와 같은 콜 스택(= 실행 스택)이 생성되고 소멸된다.  
코드를 차례대로 살펴보면서 알아보자.

<img width="500" src="https://poiemaweb.com/img/ec_1.png"/>
  
맨 처음 전역 코드를 실행한다. 그러면 첫 번째와 같이 전역 실행 컨텍스트가 생기고 콜 스택에 쌓인다. 전역 실행 컨텍스트는 애플리케이션이 종료될 때까지 유지된다.  
`foo()` 로 함수를 호출하면 `foo` 함수의 실행 컨텍스트가 생성되고 직전 실행 컨텍스트(여기서는 global) 위에 쌓인다.  
`foo` 안에서 `bar()`로 함수를 호출하면 또 foo 실행 컨텍스트 위에 bar 실행 컨텍스트가 생성되고 콜 스택에 쌓인다.  
함수의 실행이 끝나면 해당 함수의 실행 컨텍스트를 소멸시킨다.

## ✔️ 실행 컨텍스트의 3가지 프로퍼티

실행 컨텍스트는 물리적으로 객체의 형태를 띄며 세 가지의 프로퍼티를 가진다.

- 변수 객체(Variable Object)
- 스코프 체인(Scope Chain)
- this

### Variable Object (VO / 변수 객체)

실행 컨텍스트가 생성되면 자바스크립트 엔진은 실행에 필요한 여러 정보들을 담을 객체를 생성한다. 이를 Variable Object라고 한다. Variable Object는 코드가 실행될 때 엔진에 의해 참조되고 코드에서는 접근할 수 없다.

Variable Object는 아래의 정보를 담는다.

- 변수
- 매개변수(parameter)와 인수 정보(arguments)
- 함수 선언(함수 표현식은 제외)

Variable Object는 실행 컨텍스트의 프로퍼티이기 때문에 값을 갖는데 이 값은 다른 객체를 가리킨다. 그런데 전역 코드 실행 시 생성되는 전역 컨텍스트의 경우와, 함수를 실행할 때 생성되는 함수 컨텍스트의 경우 가리키는 객체가 다르다. 이는 전역 코드와 함수의 내용이 다르기 때문이다.예를 들어 전역 코드에는 매개변수가 없지만 함수는 매개변수가 있다.

**전역 컨텍스트**

<img width="400" src="https://poiemaweb.com/img/ec-vo-global.png"/>

Variable Object가 가리키는 객체는 전역 객체이다.

**함수 컨텍스트**

<img width="400" src="https://poiemaweb.com/img/ec-vo-foo.png"/>

Variable Object가 가리키는 객체는 Activation Object(AO / 활성 객체)이며 매개변수와 인수 정보를 배열로 담고 있는 객체인 arguments object가 추가된다.

### 스코프 체인(Scope Chain)

스코프 체인은 일종의 리스트로서 전역 객체와 중첩된 함수의 스코프의 레퍼런스를 차례로 저장하고 있다. 스코프 체인은 해당 전역 또는 함수가 참조할 수 있는 변수, 함수 선언 등의 정보를 담고 있는 **전역 객체(GO) or 활성 객체(AO)의 리스트**를 가리킨다.

현재 실행 컨텍스트의 활성 객체(AO)를 선두로 하여 순차적으로 상위 컨텍스트의 활성 객체(AO)를 가리키며 마지막 리스트는 전역 객체(GO)를 가리킨다.

<img width="400" src="https://poiemaweb.com/img/ec-sc.png"/>

실행 컨텍스트에서 변수를 탐색할 때 가장 가까운 스코프부터 전역 스코프까지 탐색하는 것을 생각해 보자. 이 스코프 체인을 이용해 거슬러 올라가며 탐색한다고 생각하면 쉬울 것 같다.

엔진은 스코프 체인을 통해 렉시컬 스코프를 파악한다. 함수가 중첩 상태일 때 하위 함수 내에서 상위 함수의 스코프와 전역 스코프까지 참조할 수 있는데 이것은 스코프 체인을 검색함으로써 가능한 일이다. 함수가 중첩되어 있으면 중첩될 때마다 부모 함수의 Scope가 자식 함수의 스코프 체인에 포함된다. 함수 실행 중에 변수를 만나면 그 변수를 우선 현재 스코프인 AO에서 검색해 보고, 검색에 실패하면 스코프 체인에 담겨진 순서대로 검색을 이어나간다.

이런 식으로 변수를 검색하다가 결국 검색에 실패하면 정의되지 않은 변수에 접근하는 것으로 판단해 Reference 에러를 발생시킨다. 스코프 체인은 함수의 감춰진 프로퍼티인 `[[Scope]]`로 참조할 수 있다.

### this

this 프로퍼티에는 this의 값이 할당된다. this에 할당되는 값은 함수 호출 패턴에 의해 결정된다. 자세한 것은 this를 알아보도록!

## ✔️ 실행 컨텍스트의 역할

```
// 1. 전역 변수 선언
const x = 1;
const y = 2;

// 2. 함수 선언
function foo(a) {
    // 3. 지역 변수 선언
    const x = 10;
    const y = 20;

    // 4. 메서드 호출
    console.log(a + x + y);
}

// 5. 함수 호출
foo(100);

// 6. 메서드 호출
console.log(x + y);
```

**전역 코드 평가** 과정에서는 `1. 전역 변수 선언문`과 `2. 함수 선언문`만 실행되고, 전역 변수와 전역 함수가 실행 컨텍스트가 관리하는 전역 스코프(global scope)에 등록된다.
전역 코드 평가가 끝나면 **전역 코드**가 **실행**되기 시작한다. 이때 전역 변수에 값이 할당되고 함수가 호출된다.

### 참고

모던 자바스크립트 Deep Dive  
[실행 컨텍스트와 자바스크립트의 동작 원리](https://poiemaweb.com/js-execution-context)
