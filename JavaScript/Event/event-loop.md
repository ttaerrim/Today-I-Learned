# 이벤트 루프

## ✔️ 이벤트란?

브라우저에서의 이벤트란 사용자가 버튼을 클릭했을 때, 웹 페이지가 로드되었을 때와 같은 것인데 이것은 DOM 요소와 관련이 있다.

이벤트가 발생하는 시점이나 순서를 사전에 알 수 없으므로 일반적인 제어 흐름과 다른 접근 방식이 필요하다. 즉, 이벤트가 발생하면 누군가 이를 감지하고 그에 대응하는 처리를 해야 한다.

브라우저는 이벤트를 감지하고 이벤트 발생 시에 통지해 준다. 이 과정을 통해 사용자와 웹 페이지가 상호작용할 수 있다.

이를 위해 이벤트는 일반적으로 함수에 연결되고, 그 함수는 이벤트가 발생되면 실행된다. 이 함수를 **이벤트 핸들러**라고 하며 이벤트에 대응하는 처리를 기술한다.

## ✔️ 이벤트 루프

브라우저는 싱글 스레드(Single Thread)에서 이벤트 드리븐(event-driven) 방식으로 동작한다.

싱글 스레드는 스레드가 하나뿐이라는 의미이고 이 말은 곧 하나의 작업(태스크)만을 처리할 수 있다는 것을 의미한다. 하지만 실제로 동작하는 웹 애플리케이션은 많은 태스크가 동시에 동작하는 것처럼 느껴지는데, 이처럼 자바스크립트의 동시성을 지원하는 것이 바로 **이벤트 루프**이다.

브라우저의 환경은 다음과 같이 동작한다.

<img src="https://poiemaweb.com/img/event-loop.png"/>

자바스크립트 엔진은 크게 두 개의 영역으로 나뉜다.

1. **Call Stack(콜 스택/호출 스택)**

   작업이 요청되면(함수가 호출되면) 요청된 작업은 순차적으로 콜 스택에 쌓이고 순차적으로 실행된다. 자바스크립트는 단 하나의 콜 스택을 사용하기 때문에 해당 태스크가 종료하기 전까지는 다른 어떤 태스크도 수행할 수 없다. 가장 나중에 쌓인 최상단의 실행 컨텍스트가 실행된다.

2. **Heap**

   동적으로 생성된 객체 인스턴스가 할당되는 영역이다.

이와 같이 자바스크립트 엔진은 작업이 요청되면 콜 스택을 사용해 요청된 작업을 순차적으로 실행한다. 동시성을 지원하기 위해서는 비동기 처리를 해야 하는데 이는 자바스크립트 엔진을 구동하는 환경인 브라우저(or Node.js)가 담당한다.

1. **Event Queue (= Task Queue = Callback Queue)**

   비동기 처리 함수의 콜백 함수, 비동기식 이벤트 핸들러, Timer 함수(setTimeout, setInterval)의 콜백 함수가 보관되는 영역이다. 이벤트 루프에 의해 콜 스택이 비었을 때 순차적으로 콜 스택으로 이동되어 실행된다.

2. **Event Loop**

   콜 스택 내에 현재 실행 중인 태스크가 있는지, 이벤트 큐에 대기 중인 태스크가 있는지 반복하여 확인한다. 만약 콜 스택이 비어 있다면 이벤트 큐 내의 태스크가 콜 스택으로 이동하고 실행된다.

예시를 살펴보자.

```javascript
const foo = () => console.log("First");
const bar = () => setTimeout(() => console.log("Second"), 500);
const baz = () => console.log("Third");

bar();
foo();
baz();
```

<img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BLtCLQcd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://devtolydiahallie.s3-us-west-1.amazonaws.com/gif14.1.gif"/>

1. `bar` 함수를 호출했다. `bar`는 `setTimeout` 함수를 반환한다. `bar`와 `setTimeout`가 콜 스택에 쌓였다.
2. `setTimeout`의 콜백 함수는 Web API를 호출하여 `setTimeout`가 콜 스택에서 나가고 Web API는 정해진 시간 후에 콜백 함수를 이벤트 큐로 보낸다. `bar`도 콜 스택에서 나간다.
3. `foo` 함수를 호출했다. `foo`가 콜 스택에 쌓였다가 실행이 종료되면 콜 스택에서 나간다.
4. `baz` 함수를 호출했다. `baz`가 콜 스택에 쌓였다가 실행이 종료되면 콜 스택에서 나간다.
5. 콜 스택에 아무것도 없는 것을 확인한 이벤트 루프는 이벤트 큐에 있는 콜백 함수를 콜 스택으로 보내 실행시킨다. 콜백 함수도 실행 후 콜 스택에서 나간다.

### 🚩 참고

- [이벤트](https://poiemaweb.com/js-event)
- [✨♻️ JavaScript Visualized: Event Loop](https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif)
