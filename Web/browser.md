# 브라우저 동작 원리

## ✔️ 웹 동작 방식

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdmomKO%2FbtqK84xb9yy%2FktAElZQp6AFyxgXG35eORk%2Fimg.png" />

1. 사용자가 브라우저 주소 창에 접속하고자 하는 웹의 URL을 입력한다.
2. URL이 브라우저에게 전달되고, 브라우저는 DNS를 통해 서버의 IP 주소를 찾는다.
3. HTTP 프로토콜을 사용하여 HTTP 요청 메시지를 생성한다.
4. TCP/IP 연결을 통해 HTTP 요청 메시지가 서버로 전송된다.
5. 서버는 HTTP 프로토콜을 사용하여 HTTP 응답 메시지를 생성한다.
6. TCP/IP 연결을 통해 HTTP 응답 메시지를 요청한 클라이언트에게 전달한다.
7. 도착한 HTTP 응답 메시지는 웹 페이지 데이터로 변환되고 브라우저에 의해 출력되어 사용자에게 보여진다.

## ✔️ 브라우저의 기본 구조

브라우저의 주요 구성 요소는 다음과 같다.

1. 사용자 인터페이스

   주소 표시줄, 이전/다음 버튼, 북마크 메뉴 등 요청한 페이지를 보여 주는 창 제외한 나머지 모든 부분

2. 브라우저 엔진

   사용자 인터페이스와 렌더링 엔진 사이의 동작을 제어

3. 렌더링 엔진

   요청한 콘텐츠를 표시  
   예를 들어 HTML을 요청하면 HTML과 CSS를 파싱하여 화면에 표시함

4. 통신

   HTTP 요청과 같은 네트워크 호출에 사용됨  
   이것은 플랫폼 독립적인 인터페이스이고 각 플랫폼 하부에서 실행됨

5. UI 백엔드

   콤보 박스와 창 같은 기본적인 장치를 그림  
   플랫폼에서 명시하지 않은 일반적인 인터페이스로서 OS 사용자 인터페이스 체계를 사용

6. 자바스크립트 해석기

   자바스크립트 코드를 해석하고 실행

7. 자료 저장소

   쿠키를 저장하는 것과 같이 자료를 저장하는 계층

<img src="https://d2.naver.com/content/images/2015/06/helloworld-59361-1.png" />

## ✔️ 브라우저 렌더링 과정

브라우저의 핵심 기능은 사용자가 접속하고자 하는 웹 페이지를 서버에 요청(request)하고 서버의 응답(response)을 받아 브라우저에 표시하는 것이다.

### 렌더링 엔진

<img src="https://d2.naver.com/content/images/2015/06/helloworld-59361-2.png" />

브라우저는 서버로부터 HTML, CSS, JavaScript, 이미지 파일 등을 응답받는다.

렌더링 엔진은 HTML 문서를 파싱하고 콘텐츠 트리 내부에서 태그를 DOM 노드로 변환한다. 그 다음 외부 CSS 파일과 함께 포함된 스타일 요소를 파싱해 CSSOM 트리로 변환한다. 그리고 DOM, CSSOM 트리로 변환되고 렌더 트리로 결합된다.

렌더 트리는 정해진 순서대로 화면에 표시된다. 렌더 트리의 생성이 끝나면 각 노드가 화면의 정확한 위치에 배치된다. 다음은 UI 백엔드에서 렌더 트리의 각 노드를 가로지르며 형상을 만들어 내는 과정을 거친다.

렌더링 엔진은 좀 더 나은 사용자 경험을 위해 가능하면 빠르게 내용을 표시하는데 모든 HTML을 파싱할 때까지 기다리지 않고 배치와 그리기 과정을 시작한다. 네트워크로부터 나머지 내용이 전송되기를 기다리는 동시에 받은 내용의 일부를 먼저 화면에 표시하는 것이다.

<img src="https://d2.naver.com/content/images/2015/06/helloworld-59361-3.png" />

### 파싱

파싱은 브라우저가 코드를 이해하고 사용할 수 있는 구조로 변환하는 것을 의미한다. 파싱 결과는 보통 문서 구조를 나타내는 노드 트리(=파싱 트리 =문법 트리)이다.

2+3-1의 표현식을 파싱한 결과는 다음과 같은 트리가 된다.

<img src="https://d2.naver.com/content/images/2015/06/helloworld-59361-5.png" />

자바스크립트는 렌더링 엔진이 아닌 자바스크립트 엔진이 처리한다. HTML 파서는 HTML 코드를 읽다가 script 태그를 만나면 자바스크립트 코드를 실행하기 위해 DOM 생성 프로세스를 중지한다. 그리고 자바스크립트 엔진으로 제어 권한을 넘긴다. 제어 권한을 넘겨 받은 자바스크립트 엔진은 script 태그 내에 작성된 자바스크립트 코드 또는 script 태그의 src 어트리뷰트에 정의된 자바스크립트 파일(`<script src="src/index.js"/>` 형식)을 로드하고 파싱하여 실행한다. 자바스크립트의 실행이 완료되면 다시 HTML 파서로 제어 권한을 넘겨 브라우저가 중지했던 시점부터 DOM 생성을 재개한다.

<img src="https://poiemaweb.com/img/client-server.png" />

이처럼 브라우저는 동기적으로 HTML, CSS, JavaScript를 처리한다. 이것은 script 태그의 위치에 따라 블로킹이 발생하여 DOM의 생성이 지연될 수 있다는 것을 의미한다. 따라서 script 태그의 위치는 중요한 의미를 갖는다.

그래서 HTML 파일을 작성할 때 자바스크립트 코드를 body 요소의 가장 아래에 위치시키는 것을 권장하곤 한다. 그 이유는 아래와 같다.

- HTML 요소들이 스크립트 로딩 지연으로 인해 렌더링에 지장 받는 일이 발생하지 않아 페이지 로딩 시간이 단축된다.

- DOM이 완성되지 않은 상태에서 자바스크립트가 DOM을 조작한다면 에러가 발생한다.

### 🚩 참고

- [브라우저는 어떻게 동작하는가?](https://d2.naver.com/helloworld/59361)
- [브라우저 동작 원리](https://poiemaweb.com/js-browser)
